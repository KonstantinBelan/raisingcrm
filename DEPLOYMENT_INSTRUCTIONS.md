# Инструкции по развертыванию исправлений

## Обзор исправлений

Были исправлены следующие проблемы:

1. ✅ **Трекинг времени** - добавлена полная поддержка с сохранением в БД
2. ✅ **Перетаскивание карточек** - исправлена ошибка валидации статусов
3. ✅ **Отображение платежей клиентов** - добавлена фильтрация по clientId
4. ✅ **Расчет общего бюджета** - исправлен расчет в API клиентов
5. ✅ **Путаница в аналитике** - исправлено отображение "Ожидается" и "Просрочено"
6. ✅ **Фильтрация по периоду** - добавлены отладочные логи и улучшена UX
7. ✅ **Кодировка PDF** - добавлена транслитерация для корректного отображения

## Необходимые шаги для развертывания

### 1. Обновление базы данных

```bash
# Перейти в директорию проекта
cd /Users/kosbelan/Desktop/Проекты\ 2025/Фриланс\ CMS/raising-crm

# Сгенерировать и применить миграции Prisma
npx prisma generate
npx prisma db push

# Или создать миграцию (рекомендуется для продакшена)
npx prisma migrate dev --name "add-time-sessions-and-update-task-hours"
```

### 2. Перезапуск Docker контейнеров

```bash
# Остановить контейнеры
docker-compose down

# Пересобрать и запустить
docker-compose up --build -d

# Или только перезапустить приложение
docker-compose restart app
```

### 3. Проверка работоспособности

После развертывания проверьте:

1. **Трекинг времени**: 
   - Откройте любую задачу `/tasks/[id]`
   - Нажмите "Начать работу" и "Остановить"
   - Проверьте, что время сохраняется в истории

2. **Kanban доска**:
   - Перейдите на `/tasks/board`
   - Попробуйте перетащить карточку между колонками
   - Убедитесь, что нет ошибок в консоли

3. **Платежи клиентов**:
   - Откройте страницу клиента `/clients/[id]`
   - Перейдите на вкладку "Платежи"
   - Проверьте отображение истории платежей

4. **Аналитика**:
   - Откройте `/analytics`
   - Измените период фильтрации
   - Проверьте корректность данных в графиках

5. **Экспорт PDF**:
   - Попробуйте экспортировать данные в PDF
   - Убедитесь, что русский текст отображается корректно (транслитерацией)

## Изменения в схеме базы данных

### Новая модель TimeSession

```prisma
model TimeSession {
  id        String   @id @default(cuid())
  startTime DateTime
  endTime   DateTime
  duration  Float    // Duration in seconds
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("time_sessions")
}
```

### Обновления в модели Task

- Изменен тип `estimatedHours` и `actualHours` с `Int?` на `Float?`
- Добавлена связь с `timeSessions: TimeSession[]`

### Обновления в модели User

- Добавлена связь с `timeSessions: TimeSession[]`

## Новые API эндпоинты

### Трекинг времени

- `GET /api/tasks/[id]/time-sessions` - получить сессии трекинга времени
- `POST /api/tasks/[id]/time-sessions` - создать новую сессию

### Улучшения существующих API

- `GET /api/payments?clientId=[id]` - фильтрация платежей по клиенту
- `GET /api/clients/[id]` - теперь возвращает `totalBudget`
- `GET /api/analytics/payments` - улучшена фильтрация по периоду

## Возможные проблемы и решения

### 1. Ошибки TypeScript после обновления схемы

```bash
# Перегенерировать Prisma клиент
npx prisma generate

# Перезапустить TypeScript сервер в IDE
# В VS Code: Ctrl+Shift+P -> "TypeScript: Restart TS Server"
```

### 2. Проблемы с миграцией базы данных

```bash
# Сбросить базу данных (ОСТОРОЖНО - удалит все данные!)
npx prisma migrate reset

# Или применить миграции принудительно
npx prisma db push --force-reset
```

### 3. Проблемы с Docker

```bash
# Очистить кеш Docker
docker system prune -a

# Пересобрать контейнеры с нуля
docker-compose down -v
docker-compose up --build
```

## Рекомендации для продакшена

1. **Создайте бэкап базы данных** перед применением миграций
2. **Протестируйте изменения** на staging окружении
3. **Мониторьте логи** после развертывания
4. **Проверьте производительность** новых запросов к БД

## Контакты для поддержки

При возникновении проблем обратитесь к разработчику с описанием:
- Шагов для воспроизведения проблемы
- Сообщений об ошибках из консоли браузера
- Логов Docker контейнеров (`docker-compose logs`)
